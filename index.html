<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- Viewport-fit=cover es CRUCIAL para que use todo el iPhone, detr√°s del notch -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Budapest Quest</title>
    
    <!-- Cargamos Tailwind CSS para el dise√±o -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Cargamos FontAwesome para los √≠conos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Cargamos React -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Cargamos Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.6/babel.min.js"></script>

    <style>
        body { 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            background-color: #020617; 
            -webkit-tap-highlight-color: transparent;
        }
        * { touch-action: manipulation; }
        #root { width: 100vw; height: 100vh; }
        
        /* Premium Background Gradient */
        .bg-radar {
            background: radial-gradient(circle at center, #083344 0%, #020617 70%);
        }

        /* Glassmorphism utilities */
        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .loading-text { color: #22d3ee; text-align: center; margin-top: 40vh; font-family: sans-serif; font-weight: bold; font-size: 1.2rem; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Ocultar barra de scroll en los paneles */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const root = document.getElementById('root');
            if(root) {
                root.innerHTML = '<div style="background:#020617; color:#fca5a5; padding:env(safe-area-inset-top) 20px 20px; font-family:sans-serif; height:100vh; overflow:auto;">' +
                    '<h2 style="color:white; font-weight:bold; font-size: 1.5rem;">¬°Ups! Algo fall√≥.</h2>' +
                    '<p style="margin-top: 10px;">T√≥male captura a esto y m√°ndalo al programador:</p>' +
                    '<div style="background:#000; padding:15px; border-radius:10px; margin-top:15px; font-family:monospace; border: 1px solid #334155;">' + message + '<br><br>L√≠nea: ' + lineno + '</div>' +
                '</div>';
            }
        };
    </script>
</head>
<body class="bg-slate-950 text-slate-100 overflow-hidden select-none">
    
    <div id="root">
        <div class="loading-text">Cargando experiencia... üçª</div>
    </div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- DATA & CONFIGURATION ---
        const ALL_CHALLENGES = [
          { id: 'c1', text: "The Reverse Chug", description: "Drink your entire beer or shot while leaning backwards (limbo style) or using a straw. No spilling allowed!", points: 1, level: 1 },
          { id: 'c2', text: "The Fanboy", description: "Approach a stranger, ask for their autograph on a napkin, and act overly excited like they are a famous celebrity.", points: 1, level: 1 },
          { id: 'c3', text: "The Dark Ritual", description: "Gather your team around 'The Egg' (or a central object) and perform a silent, spooky ritual for 30 seconds.", points: 1, level: 1 },
          { id: 'c4', text: "RPS Champion", description: "Challenge a stranger to Rock-Paper-Scissors. You must win 2 out of 3 rounds to claim this point.", points: 1, level: 1 },
          { id: 'c5', text: "Poison Shot", description: "Ask the bartender for the weirdest or most unpopular shot they have and drink it without making a face.", points: 1, level: 1 },
          { id: 'c6', text: "Lipstick Jungle", description: "Wear bright red/pink lipstick for the next 30 minutes inside the bar. (Yes, the guys too!).", points: 1, level: 1 },
          { id: 'c7', text: "Call Me Maybe", description: "Write a fake number on a napkin, have the waiter deliver it to another table, and wave at them mysteriously.", points: 1, level: 1 },
          { id: 'c8', text: "The TP Tail", description: "Tuck a long strip of toilet paper into your pants and walk proudly across the entire bar with your 'tail'.", points: 1, level: 1 },
          
          { id: 'c9', text: "The Bartender", description: "Charm the bartender! Successfully get their Instagram handle or phone number.", points: 2, level: 2 },
          { id: 'c10', text: "Free Loader", description: "Hustle a free drink or shot from anyone who is NOT on your team (staff or stranger).", points: 2, level: 2 },
          { id: 'c11', text: "Holy Egg", description: "Convince a total stranger to kiss 'The Egg' (or a specific statue/decoration in the bar).", points: 2, level: 2 },
          { id: 'c12', text: "The Preacher", description: "Stand on a chair (or safe spot) and preach the religion of the 'Birthday God' to a group of strangers for 1 minute.", points: 2, level: 2 },
          { id: 'c13', text: "Chug Buddy", description: "Challenge a stranger to a chug contest. You must both finish your drinks. (Win or lose, you get the points).", points: 2, level: 2 },
          { id: 'c14', text: "Old Friends", description: "Walk up to a stranger and pretend you know them from high school. Keep the conversation going for 60 seconds.", points: 2, level: 2 },
          { id: 'c15', text: "Look Ma No Hands", description: "Take a shot without using your hands. It must be sitting on the table or fed to you by a teammate.", points: 2, level: 2 },
          { id: 'c16', text: "Marry Me", description: "Get down on one knee and stage a loud, fake marriage proposal to a teammate in the middle of the crowd.", points: 2, level: 2 },
          { id: 'c17', text: "Domestic Drama", description: "Stage a fake couple's argument with a teammate. Bonus points if it ends with a (gentle) slap or drink splash.", points: 2, level: 2 },
          { id: 'c18', text: "Blessing", description: "Politely ask a stranger to kiss you on the forehead as a 'blessing' for your journey.", points: 2, level: 2 },
          { id: 'c19', text: "Stare Down", description: "Challenge a stranger to a staring contest. You must be less than 10cm away. First to laugh loses.", points: 2, level: 2 },
          { id: 'c20', text: "Digits", description: "Successfully ask a stranger for their real phone number.", points: 2, level: 2 },
          
          { id: 'c21', text: "The Beggar", description: "Convince a stranger to give you a bite of their food or a sip of their drink (No stealing!).", points: 3, level: 3 },
          { id: 'c22', text: "The Bat", description: "Drink a shot while being held upside down by your teammates.", points: 3, level: 3 },
          { id: 'c23', text: "Cheerleader", description: "Build a human pyramid with your team right outside the bar entrance.", points: 3, level: 3 },
          { id: 'c24', text: "Superman", description: "Go to the bathroom, put your underwear OVER your pants, and order a drink at the bar like that.", points: 3, level: 3 },
          { id: 'c25', text: "Choir", description: "Get a table of strangers to sing 'Happy Birthday' to you (or your phone) on video.", points: 3, level: 3 },
          { id: 'c26', text: "The Bouncer", description: "Convince the Security Guard to take a 'Duck Face' selfie with you.", points: 3, level: 3 },
          { id: 'c27', text: "The Sommelier", description: "Go to a stranger, ask to taste their drink with a straw, and give a serious critique like a wine expert.", points: 3, level: 3 },
          { id: 'c28', text: "Creepy Lemon", description: "Make eye contact with a stranger and slowly, uncomfortably lick a lemon slice without breaking eye contact.", points: 3, level: 3 },
          { id: 'c29', text: "The Mute", description: "Order a complex drink at the bar using ONLY sign language/gestures. No speaking allowed.", points: 3, level: 3 },
          { id: 'c30', text: "Broken Heart", description: "Tell a stranger a fake breakup story and try to squeeze out real tears.", points: 3, level: 3 },
          { id: 'c31', text: "Egg Signature", description: "Get a stranger to sign their name on 'The Egg' (or your arm/shirt).", points: 3, level: 3 },
          { id: 'c32', text: "The Golden Kiss", description: "JACKPOT: Convince a stranger to kiss you on the lips.", points: 5, level: 3 },
        ];

        const BAR_ASSIGNMENTS = [
          ALL_CHALLENGES[0], ALL_CHALLENGES[8], ALL_CHALLENGES[20], 
          ALL_CHALLENGES[1], ALL_CHALLENGES[9], ALL_CHALLENGES[21],
          ALL_CHALLENGES[2], ALL_CHALLENGES[10], ALL_CHALLENGES[22],
          ALL_CHALLENGES[3], ALL_CHALLENGES[11], ALL_CHALLENGES[23],
          ALL_CHALLENGES[4], ALL_CHALLENGES[12], ALL_CHALLENGES[24],
          ALL_CHALLENGES[5], ALL_CHALLENGES[13], ALL_CHALLENGES[25],
          ALL_CHALLENGES[6], ALL_CHALLENGES[14]
        ];

        const EXTRA_CHALLENGES = ALL_CHALLENGES.slice(20);

        // --- TRIVIA QUESTIONS ---
        const HARD_QUESTIONS = [
          { q: "Sum the age of the birthday boy plus the number of letters in his name (Eduardo).", a: ["37", "thirty-seven", "37 letters", "thirty seven"] },
          { q: "If Edu were to double his age in 15 years, what age would he be?", a: ["90", "ninety", "90 years old"] },
          { q: "How many squares does a Rubik's cube have?", a: ["54", "fifty-four", "54 squares"] },
          { q: "How many elements are currently in the periodic table?", a: ["118", "one hundred eighteen"] },
          { q: "How many meters tall is the tallest building in Budapest?", a: ["143", "143m", "143 meters", "mol campus"] },
          { q: "If Budapest was unified in 1873, how old is the city in 2026?", a: ["153", "one hundred fifty-three", "153 years"] },
          { q: "If the parliament was inaugurated in 1904, how many years older is it than Edu?", a: ["92", "ninety-two", "92 years"] },
          { q: "If Edu was born on 20 Feb 1996 and 30 years have passed, what was the day Edu was born?", a: ["tuesday", "tue", "tuesday night"] }
        ];

        const MEDIUM_QUESTIONS = [
          { q: "How many letters are in the mexican state where Baby Edu was born?", a: ["9", "nine", "9 letters"] },
          { q: "How many degrees is the sum of the internal angles of a triangle?", a: ["180", "180 degrees", "180¬∞", "one hundred eighty"] },
          { q: "If Baby Edu was born in 1996, how old was he in 2020?", a: ["24", "twenty-four", "24 years", "twenty four"] },
          { q: "How many months of the year have 28 days?", a: ["12", "twelve", "all 12", "all of them"] },
          { q: "How many letters are in Baby Edu's full name (without spaces)?", a: ["25", "twenty-five", "25 letters"] },
          { q: "How old was Baby Edu when he left his country for the first time?", a: ["28", "twenty-eight", "age 28"] },
          { q: "How many lions are there on the Chain Bridge?", a: ["4", "four", "4 lions"] }
        ];

        const EASY_QUESTIONS = [
          { q: "What is Edu's current age?", a: ["30", "thirty", "30 years old", "age 30"] },
          { q: "I have needles but I don't prick, I have numbers but I don't speak. How many hours do I mark in a full cycle?", a: ["12", "twelve", "12 hours"] },
          { q: "What is the name of the most famous bridge that connects Buda and Pest?", a: ["chain bridge", "sz√©chenyi chain bridge", "puente de las cadenas"] },
          { q: "Which number is the district famous for its ruin pubs like Szimpla Kert?", a: ["7", "district vii", "district 7", "7th district", "erzs√©betv√°ros", "jewish district"] },
          { q: "How many colors does the Hungarian flag have in common with the Mexican flag?", a: ["3", "three", "3 colors", "red white green"] },
          { q: "What past decision do you think changed the birthday boy's life the most?", a: ["budapest", "moving to budapest", "budapest city", "live in budapest", "move to budapest"] }
        ];

        const RAW_BARS = [
          { id: 3, name: "Szimpla Kert", lat: 50, lng: 50, link: "https://maps.app.goo.gl/GMLpoUnNSq3Bqmky5", challenge: BAR_ASSIGNMENTS[2] },
          { id: 12, name: "Ruin Brew", lat: 48, lng: 48, link: "https://maps.app.goo.gl/BUXZwwbuHwyeUE9CA", challenge: BAR_ASSIGNMENTS[11] },
          { id: 5, name: "Fekete Kutya", lat: 52, lng: 42, link: "https://maps.app.goo.gl/4h475TmbQyMwSBCy7", challenge: BAR_ASSIGNMENTS[4] },
          { id: 18, name: "Kis√ºem", lat: 53, lng: 53, link: "https://maps.app.goo.gl/KCghMmcj8VViQBjA6", challenge: BAR_ASSIGNMENTS[17] },
          { id: 20, name: "Bobek Kert", lat: 51, lng: 45, link: "https://maps.app.goo.gl/xCKJ2jzSdegwDV4NA", challenge: BAR_ASSIGNMENTS[19] },
          { id: 4, name: "Piana Vyshni–∞", lat: 49, lng: 35, link: "https://maps.app.goo.gl/qmQerfiwqqNQcuVcA", challenge: BAR_ASSIGNMENTS[3] },
          { id: 15, name: "Anytime Bar", lat: 45, lng: 38, link: "https://maps.app.goo.gl/TPVhtPGceUTKrMDo8", challenge: BAR_ASSIGNMENTS[14] },
          { id: 16, name: "DZZS Bar", lat: 55, lng: 36, link: "https://maps.app.goo.gl/SuMXN9fpduhaRhC4A", challenge: BAR_ASSIGNMENTS[15] },
          { id: 8, name: "K√∂zpont", lat: 65, lng: 30, link: "https://maps.app.goo.gl/n7opnM2b5m5qwSzp8", challenge: BAR_ASSIGNMENTS[7] },
          { id: 17, name: "Telep", lat: 66, lng: 28, link: "https://maps.app.goo.gl/Bq9gooYQVddp35rD7", challenge: BAR_ASSIGNMENTS[16] },
          { id: 9, name: "L√°mp√°s Pub", lat: 55, lng: 58, link: "https://maps.app.goo.gl/MoXGKzYMcnVZFiBZ8", challenge: BAR_ASSIGNMENTS[8] },
          { id: 10, name: "HOPS BEER BAR", lat: 47, lng: 60, link: "https://maps.app.goo.gl/QgmN5AGqorgPPEpF7", challenge: BAR_ASSIGNMENTS[9] },
          { id: 6, name: "Stifler Bar", lat: 25, lng: 65, link: "https://maps.app.goo.gl/tnBSUnzy4GDewide9", challenge: BAR_ASSIGNMENTS[5] },
          { id: 11, name: "4es6os Wessel√©nyi", lat: 28, lng: 60, link: "https://maps.app.goo.gl/RhEaHeXvbhPPLVvMA", challenge: BAR_ASSIGNMENTS[10] },
          { id: 14, name: "Humb√°k Bork√°polna", lat: 22, lng: 68, link: "https://maps.app.goo.gl/QoK5H3nzrJnFFpoV7", challenge: BAR_ASSIGNMENTS[13] },
          { id: 19, name: "Hoff House", lat: 30, lng: 50, link: "https://maps.app.goo.gl/hgFDQMf8gQSJd72J8", challenge: BAR_ASSIGNMENTS[18] },
          { id: 1, name: "Rizmajer", lat: 60, lng: 75, link: "https://maps.app.goo.gl/KiFALAH89TUXKVbp8", challenge: BAR_ASSIGNMENTS[0] },
          { id: 2, name: "Hintal√≥ B√°r", lat: 65, lng: 72, link: "https://maps.app.goo.gl/hGQHU2NZm1PhK26f9", challenge: BAR_ASSIGNMENTS[1] },
          { id: 7, name: "Matt Bar", lat: 40, lng: 70, link: "https://maps.app.goo.gl/CcT6xVp581fVn4keA", challenge: BAR_ASSIGNMENTS[6] },
          { id: 13, name: "57-es sz√°m√∫", lat: 35, lng: 73, link: "https://maps.app.goo.gl/dSr9prqo99MkxRxC8", challenge: BAR_ASSIGNMENTS[12] },
        ];

        let hardIndex = 0;
        let medIndex = 0;
        let easyIndex = 0;

        const INITIAL_BARS = RAW_BARS.map((bar) => {
          let triviaQuestion;
          const level = bar.challenge.level;

          if (level === 1) {
            triviaQuestion = HARD_QUESTIONS[hardIndex];
            hardIndex = (hardIndex + 1) % HARD_QUESTIONS.length;
          } else if (level === 2) {
            triviaQuestion = MEDIUM_QUESTIONS[medIndex];
            medIndex = (medIndex + 1) % MEDIUM_QUESTIONS.length;
          } else {
            triviaQuestion = EASY_QUESTIONS[easyIndex];
            easyIndex = (easyIndex + 1) % EASY_QUESTIONS.length;
          }

          return { ...bar, trivia: triviaQuestion };
        });

        const App = () => {
          const [activeBar, setActiveBar] = useState(null);
          const [activeQuestionBar, setActiveQuestionBar] = useState(null);
          const [showSidebar, setShowSidebar] = useState(false);
          const [showExtras, setShowExtras] = useState(false);
          
          const [userState, setUserState] = useState({
            completed: [],
            extraCompleted: [],
            unlockedBars: []
          });
          
          const [showConfetti, setShowConfetti] = useState(false);
          const [answerInput, setAnswerInput] = useState("");
          const [answerError, setAnswerError] = useState(false);

          const [mapTransform, setMapTransform] = useState({ x: 0, y: 0, scale: 1 });
          const isDragging = useRef(false);
          const lastPosition = useRef({ x: 0, y: 0 });
          const pinchStartDist = useRef(null);
          const pinchStartScale = useRef(null);

          const calculateScore = () => {
            let score = 0;
            userState.completed.forEach(barId => {
              const bar = INITIAL_BARS.find(b => b.id === barId);
              if (bar) score += bar.challenge.points * 100;
            });
            userState.extraCompleted.forEach(chId => {
              const challenge = EXTRA_CHALLENGES.find(c => c.id === chId);
              if (challenge) score += challenge.points * 100;
            });
            return score;
          };
          const currentScore = calculateScore();

          // L√ìGICA DE PANEO INFINITO RELAJADO (Resuelve el problema rectangular)
          const getConstrainedTransform = (newX, newY, newScale) => {
            // El mapa de fondo ahora es enorme (4000x4000)
            const MIN_SCALE = 0.3; // Permite alejar m√°s
            const MAX_SCALE = 5;
            const constrainedScale = Math.max(MIN_SCALE, Math.min(newScale, MAX_SCALE));

            // Relajamos los bordes: Permitimos salirnos hasta 1500px del centro para explorar el "infinito"
            const maxPan = 1500 * constrainedScale; 
            
            const constrainedX = Math.max(-maxPan, Math.min(newX, maxPan));
            const constrainedY = Math.max(-maxPan, Math.min(newY, maxPan));

            return { x: constrainedX, y: constrainedY, scale: constrainedScale };
          };

          const handlePinClick = (bar) => {
            if (isUnlocked(bar.id)) {
              setActiveBar(bar);
              setActiveQuestionBar(null);
            } else {
              setActiveQuestionBar(bar);
              setActiveBar(null);
              setAnswerInput("");
              setAnswerError(false);
            }
          };

          const centerOnBar = (bar) => {
            const targetScale = 2.0;
            // Los pines viven en un sub-contenedor de 1000x1000 en el centro del mundo de 2000x2000
            const mapDX = ((bar.lng - 50) / 100) * 1000;
            const mapDY = ((bar.lat - 50) / 100) * 1000;
            
            const targetX = -mapDX * targetScale;
            const targetY = -mapDY * targetScale;
            
            const constrained = getConstrainedTransform(targetX, targetY, targetScale);
            setMapTransform(constrained);
            handlePinClick(bar);
            if (window.innerWidth < 768) setShowSidebar(false); 
          };

          const submitAnswer = (e) => {
            e.preventDefault();
            if (!activeQuestionBar) return;
            
            const userAnswer = answerInput.toLowerCase().trim();
            const validAnswers = activeQuestionBar.trivia.a;
            const isCorrect = validAnswers.some(ans => ans.toLowerCase() === userAnswer);

            if (isCorrect) {
              setUserState(prev => ({
                ...prev,
                unlockedBars: [...prev.unlockedBars, activeQuestionBar.id]
              }));
              setActiveBar(activeQuestionBar);
              setActiveQuestionBar(null);
              triggerConfetti();
            } else {
              setAnswerError(true);
            }
          };

          const toggleChallenge = (barId) => {
            const isCompleted = userState.completed.includes(barId);
            if (!isCompleted) triggerConfetti();
            setUserState(prev => ({
              ...prev,
              completed: isCompleted 
                ? prev.completed.filter(id => id !== barId)
                : [...prev.completed, barId]
            }));
          };

          const toggleExtraChallenge = (challengeId) => {
            const isCompleted = userState.extraCompleted.includes(challengeId);
            if (!isCompleted) triggerConfetti();
            setUserState(prev => ({
              ...prev,
              extraCompleted: isCompleted
                ? prev.extraCompleted.filter(id => id !== challengeId)
                : [...prev.extraCompleted, challengeId]
            }));
          };

          const triggerConfetti = () => {
            setShowConfetti(true);
            setTimeout(() => setShowConfetti(false), 2000);
          };

          const isCompleted = (id) => userState.completed.includes(id);
          const isUnlocked = (id) => userState.unlockedBars.includes(id);

          const getTouchDist = (touches) => {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.hypot(dx, dy);
          };

          const handleWheel = (e) => {
            e.preventDefault();
            const scaleAdjustment = -e.deltaY * 0.001;
            const targetScale = mapTransform.scale + scaleAdjustment;
            const constrained = getConstrainedTransform(mapTransform.x, mapTransform.y, targetScale);
            setMapTransform(constrained);
          };

          const handleMouseDown = (e) => {
            isDragging.current = true;
            lastPosition.current = { x: e.clientX, y: e.clientY };
          };

          const handleMouseMove = (e) => {
            if (!isDragging.current) return;
            const dx = e.clientX - lastPosition.current.x;
            const dy = e.clientY - lastPosition.current.y;
            lastPosition.current = { x: e.clientX, y: e.clientY };
            const targetX = mapTransform.x + dx;
            const targetY = mapTransform.y + dy;
            const constrained = getConstrainedTransform(targetX, targetY, mapTransform.scale);
            setMapTransform(constrained);
          };

          const handleMouseUp = () => {
            isDragging.current = false;
          };

          const handleTouchStart = (e) => {
            if (e.touches.length === 2) {
              isDragging.current = false;
              pinchStartDist.current = getTouchDist(e.touches);
              pinchStartScale.current = mapTransform.scale;
            } else if (e.touches.length === 1) {
              isDragging.current = true;
              const touch = e.touches[0];
              lastPosition.current = { x: touch.clientX, y: touch.clientY };
            }
          };

          const handleTouchMove = (e) => {
            if (e.touches.length === 2 && pinchStartDist.current) {
              const currentDist = getTouchDist(e.touches);
              const ratio = currentDist / pinchStartDist.current;
              const targetScale = pinchStartScale.current * ratio;
              const constrained = getConstrainedTransform(mapTransform.x, mapTransform.y, targetScale);
              setMapTransform(constrained);
            } else if (e.touches.length === 1 && isDragging.current) {
              const touch = e.touches[0];
              const dx = touch.clientX - lastPosition.current.x;
              const dy = touch.clientY - lastPosition.current.y;
              lastPosition.current = { x: touch.clientX, y: touch.clientY };
              const targetX = mapTransform.x + dx;
              const targetY = mapTransform.y + dy;
              const constrained = getConstrainedTransform(targetX, targetY, mapTransform.scale);
              setMapTransform(constrained);
            }
          };

          const handleTouchEnd = () => {
            isDragging.current = false;
            pinchStartDist.current = null;
          };

          const zoomIn = () => {
            const constrained = getConstrainedTransform(mapTransform.x, mapTransform.y, mapTransform.scale * 1.3);
            setMapTransform(constrained);
          };
          
          const zoomOut = () => {
            const constrained = getConstrainedTransform(mapTransform.x, mapTransform.y, mapTransform.scale / 1.3);
            setMapTransform(constrained);
          };
          
          const resetMap = () => {
            // Calcula escala ideal inicial basada en la pantalla
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const idealScale = Math.min(vw / 800, vh / 800);
            
            const constrained = getConstrainedTransform(0, 0, Math.max(idealScale, 0.4)); 
            setMapTransform(constrained);
          };

          const getLevelBadge = (level) => {
            if (level === 1) return <span className="px-2 py-0.5 rounded text-[10px] font-black bg-emerald-400 text-emerald-950 uppercase shadow-[0_0_15px_rgba(52,211,153,0.5)]">Easy</span>;
            if (level === 2) return <span className="px-2 py-0.5 rounded text-[10px] font-black bg-amber-400 text-amber-950 uppercase shadow-[0_0_15px_rgba(251,191,36,0.5)]">Med</span>;
            if (level === 3) return <span className="px-2 py-0.5 rounded text-[10px] font-black bg-rose-500 text-white uppercase shadow-[0_0_15px_rgba(244,63,94,0.5)]">Hard</span>;
          };

          const getLevelColor = (level) => {
            if (level === 1) return "text-emerald-400 border-emerald-400/50 bg-emerald-900/20";
            if (level === 2) return "text-amber-400 border-amber-400/50 bg-amber-900/20";
            if (level === 3) return "text-rose-400 border-rose-500/50 bg-rose-900/20";
            return "text-slate-400";
          };
          
          useEffect(() => {
            resetMap();
            window.addEventListener('resize', resetMap);
            return () => window.removeEventListener('resize', resetMap);
          }, []);

          return (
            <div className="flex h-screen w-screen bg-slate-950 text-slate-100 font-sans overflow-hidden select-none relative">
              
              {/* --- HEADER SUPERIOR PREMIUM (GLASSMORPHISM & SAFE AREA) --- */}
              {/* pt-[max(env(safe-area-inset-top),16px)] protege contra el notch del iPhone */}
              <header className="fixed top-0 inset-x-0 z-40 glass-panel pt-[max(env(safe-area-inset-top),16px)] pb-3 px-4 flex justify-between items-center shadow-[0_10px_30px_rgba(0,0,0,0.5)]">
                <div className="flex items-center gap-3">
                  <button 
                    onClick={() => setShowSidebar(true)}
                    className="w-10 h-10 flex items-center justify-center bg-black/40 backdrop-blur-md hover:bg-black/60 rounded-full border border-white/10 transition-all shadow-md text-cyan-400 active:scale-90 hover:border-cyan-500/50 hover:shadow-[0_0_15px_rgba(6,182,212,0.3)]"
                  >
                    <i className="fa-solid fa-bars" style={{fontSize: '16px'}}></i>
                  </button>
                  <div>
                    <h1 className="text-xl font-black bg-gradient-to-r from-cyan-300 to-indigo-300 bg-clip-text text-transparent leading-none tracking-tighter drop-shadow-sm">
                      BUDAPEST QUEST
                    </h1>
                  </div>
                </div>
                
                <div className="flex items-center gap-2 bg-black/40 px-4 py-2 rounded-full border border-white/10 shadow-inner backdrop-blur-md">
                  <i className="fa-solid fa-trophy text-yellow-400 drop-shadow-[0_0_8px_rgba(250,204,21,0.6)]" style={{fontSize: '16px'}}></i>
                  <div className="flex flex-col items-end leading-none">
                    <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Score</span>
                    <span className="text-lg font-black text-white">{currentScore}</span>
                  </div>
                </div>
              </header>

              {/* --- SIDEBAR MENU --- */}
              <div className={`
                fixed inset-y-0 left-0 z-50 glass-panel border-r border-white/10 transition-transform duration-300 shadow-2xl flex flex-col w-full md:w-80
                ${showSidebar ? 'translate-x-0' : '-translate-x-full'}
              `}>
                <div className="pt-[max(env(safe-area-inset-top),16px)] pb-4 px-4 border-b border-white/10 flex justify-between items-center flex-none">
                  <h2 className="text-xl font-bold text-white flex items-center gap-2">
                    <i className="fa-solid fa-list text-cyan-400"></i> Bar List
                  </h2>
                  <button onClick={() => setShowSidebar(false)} className="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-slate-300 active:scale-90 transition-all">
                    <i className="fa-solid fa-xmark"></i>
                  </button>
                </div>

                <div className="flex-1 overflow-y-auto p-3 space-y-2 pb-[env(safe-area-inset-bottom)]">
                  {INITIAL_BARS.map(bar => {
                    const unlocked = isUnlocked(bar.id);
                    return (
                      <button 
                        key={bar.id}
                        onClick={() => centerOnBar(bar)}
                        className={`w-full text-left p-4 rounded-2xl border transition-all flex items-center justify-between group shadow-sm active:scale-[0.98]
                          ${isCompleted(bar.id) 
                            ? 'border-emerald-500/40 bg-emerald-900/30' 
                            : unlocked 
                              ? 'border-white/10 bg-slate-800/50'
                              : 'border-white/5 bg-slate-900/50 opacity-60'
                          }
                          ${activeBar?.id === bar.id ? 'ring-2 ring-cyan-500 shadow-[0_0_20px_rgba(6,182,212,0.3)]' : ''}
                        `}
                      >
                        <div>
                          <div className="font-bold text-[15px] text-slate-100 flex items-center gap-2">
                            {unlocked ? bar.name : <span className="flex items-center gap-1.5"><i className="fa-solid fa-lock text-slate-500 text-xs"></i> Locked Location</span>}
                          </div>
                          {unlocked && (
                            <div className="text-xs text-slate-400 flex gap-2 mt-1.5 items-center">
                              {getLevelBadge(bar.challenge.level)}
                              <span className="font-medium text-slate-300">{bar.challenge.points * 100} pts</span>
                            </div>
                          )}
                        </div>
                        {isCompleted(bar.id) && <i className="fa-solid fa-circle-check text-emerald-400 shadow-emerald-500 drop-shadow-md text-xl"></i>}
                      </button>
                    )
                  })}
                </div>
              </div>

              {/* --- VIEWPORT DEL MAPA INFINITO --- */}
              <div 
                className="flex-1 relative w-full h-full bg-radar overflow-hidden cursor-move touch-none"
                onMouseDown={handleMouseDown}
                onMouseMove={handleMouseMove}
                onMouseUp={handleMouseUp}
                onMouseLeave={handleMouseUp}
                onWheel={handleWheel}
                onTouchStart={handleTouchStart}
                onTouchMove={handleTouchMove}
                onTouchEnd={handleTouchEnd}
              >
                {/* Contenedor del Transform */}
                <div 
                  style={{ 
                    transform: `translate(${mapTransform.x}px, ${mapTransform.y}px) scale(${mapTransform.scale})`,
                    transformOrigin: 'center',
                    transition: isDragging.current ? 'none' : 'transform 0.25s cubic-bezier(0.2, 0.8, 0.2, 1)',
                    width: '100%',
                    height: '100%'
                  }}
                  className="absolute top-0 left-0 flex items-center justify-center"
                >
                  {/* MUNDO INFINITO (4000x4000) */}
                  <div className="relative w-[4000px] h-[4000px]">
                    
                    {/* SVG DE FONDO CIBERN√âTICO CON DESVANECIMIENTO PERFECTO (AAA) */}
                    <svg 
                      viewBox="0 0 4000 4000" 
                      className="absolute inset-0 w-full h-full"
                      style={{ 
                        maskImage: 'radial-gradient(circle at 50% 50%, black 25%, transparent 65%)', 
                        WebkitMaskImage: 'radial-gradient(circle at 50% 50%, black 25%, transparent 65%)' 
                      }}
                    >
                      <defs>
                        <pattern id="smallGrid" width="50" height="50" patternUnits="userSpaceOnUse">
                          <path d="M 50 0 L 0 0 0 50" fill="none" stroke="#0ea5e9" strokeWidth="1" opacity="0.25"/>
                        </pattern>
                        <pattern id="grid" width="250" height="250" patternUnits="userSpaceOnUse">
                          <rect width="250" height="250" fill="url(#smallGrid)"/>
                          <path d="M 250 0 L 0 0 0 250" fill="none" stroke="#0ea5e9" strokeWidth="2" opacity="0.6"/>
                        </pattern>
                        {/* Brillo central */}
                        <radialGradient id="centerGlow" cx="50%" cy="50%" r="50%">
                          <stop offset="0%" stop-color="#0ea5e9" stop-opacity="0.15"/>
                          <stop offset="100%" stop-color="#0ea5e9" stop-opacity="0"/>
                        </radialGradient>
                      </defs>
                      <rect width="4000" height="4000" fill="url(#grid)" />
                      <circle cx="2000" cy="2000" r="1500" fill="url(#centerGlow)"/>

                      {/* Ejes de Cruz central cruzando TODO el mapa para evitar cortes rectos */}
                      <line x1="2000" y1="0" x2="2000" y2="4000" stroke="#38bdf8" strokeWidth="3" opacity="0.6" strokeDasharray="20,20"/>
                      <line x1="0" y1="2000" x2="4000" y2="2000" stroke="#38bdf8" strokeWidth="3" opacity="0.6" strokeDasharray="20,20"/>
                      
                      {/* Letras Cardinales Fancy expandidas */}
                      <text x="2000" y="400" textAnchor="middle" fill="#38bdf8" fontSize="120" fontWeight="black" opacity="0.8" letterSpacing="5">NORTH</text>
                      <text x="2000" y="3700" textAnchor="middle" fill="#475569" fontSize="100" fontWeight="black" opacity="0.6">SOUTH</text>
                      <text x="3700" y="2035" textAnchor="end" fill="#475569" fontSize="100" fontWeight="black" opacity="0.6">EAST</text>
                      <text x="400" y="2035" textAnchor="start" fill="#475569" fontSize="100" fontWeight="black" opacity="0.6">WEST</text>

                      {/* C√≠rculos Radar expandidos */}
                      <circle cx="2000" cy="2000" r="500" fill="none" stroke="#0ea5e9" strokeWidth="3" strokeDasharray="8,12" opacity="0.6"/>
                      <circle cx="2000" cy="2000" r="1000" fill="none" stroke="#0ea5e9" strokeWidth="2" strokeDasharray="16,24" opacity="0.5"/>
                      <circle cx="2000" cy="2000" r="1500" fill="none" stroke="#0ea5e9" strokeWidth="2" strokeDasharray="24,32" opacity="0.4"/>
                    </svg>

                    {/* ZONA DE JUEGO (1000x1000 centrado) DONDE VAN LOS PINES */}
                    <div className="absolute left-1/2 top-1/2 w-[1000px] h-[1000px] -translate-x-1/2 -translate-y-1/2">
                      {INITIAL_BARS.map((bar) => {
                        const unlocked = isUnlocked(bar.id);
                        const completed = isCompleted(bar.id);
                        const active = activeBar?.id === bar.id || activeQuestionBar?.id === bar.id;
                        
                        let pinColorClass = "text-emerald-400 drop-shadow-[0_0_8px_rgba(52,211,153,0.8)]";
                        let borderColorClass = "border-emerald-400";
                        if (bar.challenge.level === 2) { pinColorClass = "text-amber-400 drop-shadow-[0_0_8px_rgba(251,191,36,0.8)]"; borderColorClass = "border-amber-400"; }
                        if (bar.challenge.level === 3) { pinColorClass = "text-rose-400 drop-shadow-[0_0_8px_rgba(244,63,94,0.8)]"; borderColorClass = "border-rose-400"; }
                        
                        if (completed) pinColorClass = "text-white drop-shadow-[0_0_5px_white]";
                        if (!unlocked) pinColorClass = "text-slate-400";

                        const inverseScale = 1 / mapTransform.scale; 

                        return (
                          <button
                            key={bar.id}
                            onClick={(e) => { e.stopPropagation(); handlePinClick(bar); }}
                            className={`absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-300 group z-50`}
                            style={{ 
                              top: `${bar.lat}%`, 
                              left: `${bar.lng}%`,
                              transform: `translate(-50%, -50%) scale(${active ? inverseScale * 1.3 : inverseScale})` 
                            }}
                          >
                            <div className="p-6 -m-6 flex flex-col items-center">
                              <div className="relative flex flex-col items-center">
                                
                                {/* Label del Pin Fancy */}
                                <span className={`
                                  whitespace-nowrap px-3 py-1.5 glass-panel text-white text-[13px] font-black tracking-wide rounded-lg shadow-2xl mb-3 pointer-events-none
                                  ${active || (unlocked && mapTransform.scale > 1.5) ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-2'} 
                                  transition-all duration-300
                                `}>
                                  {unlocked ? bar.name : "SECRET"}
                                </span>

                                {/* Glow Din√°mico para pines desbloqueados */}
                                {unlocked && !completed && (
                                  <div className={`absolute inset-0 rounded-full blur-xl opacity-80 animate-pulse ${bar.challenge.level === 1 ? 'bg-emerald-500' : bar.challenge.level === 2 ? 'bg-amber-500' : 'bg-rose-500'}`}></div>
                                )}
                                {completed && (
                                  <div className="absolute inset-0 rounded-full blur-xl bg-emerald-500 opacity-80"></div>
                                )}

                                {/* Cuerpo del Pin */}
                                <div className={`
                                  relative w-14 h-14 rounded-full flex items-center justify-center border-2 shadow-[0_10px_25px_rgba(0,0,0,0.8)] backdrop-blur-md
                                  ${active ? `bg-slate-900 ${borderColorClass} scale-110` : 'bg-slate-900/80 border-slate-600'}
                                  ${completed ? 'bg-emerald-500 border-white' : ''}
                                  ${!unlocked ? 'bg-slate-800/90 border-slate-700' : ''}
                                `}>
                                  {unlocked ? (
                                    completed ? <i className="fa-solid fa-check text-white text-2xl font-black"></i> : <i className={`fa-solid fa-location-dot ${pinColorClass} text-2xl`}></i>
                                  ) : (
                                    <i className="fa-solid fa-lock text-slate-400 text-xl"></i>
                                  )}
                                </div>
                              </div>
                            </div>
                          </button>
                        );
                      })}
                    </div>
                  </div>
                </div>

                {/* --- CONTROLES FLOTANTES PREMIUM (Ajustados al Safe Area Bottom) --- */}
                <div className="absolute right-4 bottom-[max(env(safe-area-inset-bottom,24px),24px)] flex flex-col gap-3 z-30">
                  <button onClick={zoomIn} className="w-12 h-12 flex items-center justify-center bg-black/50 backdrop-blur-xl border border-white/10 text-white rounded-full shadow-[0_8px_32px_rgba(0,0,0,0.5)] active:scale-90 transition-all hover:border-cyan-500/50 hover:bg-black/70"><i className="fa-solid fa-plus text-lg"></i></button>
                  <button onClick={zoomOut} className="w-12 h-12 flex items-center justify-center bg-black/50 backdrop-blur-xl border border-white/10 text-white rounded-full shadow-[0_8px_32px_rgba(0,0,0,0.5)] active:scale-90 transition-all hover:border-cyan-500/50 hover:bg-black/70"><i className="fa-solid fa-minus text-lg"></i></button>
                  <button onClick={resetMap} className="w-12 h-12 flex items-center justify-center bg-black/50 backdrop-blur-xl border border-cyan-500/30 text-cyan-400 rounded-full shadow-[0_0_15px_rgba(6,182,212,0.2)] active:scale-90 transition-all hover:border-cyan-400 hover:shadow-[0_0_25px_rgba(6,182,212,0.4)]"><i className="fa-solid fa-crosshairs text-lg"></i></button>
                </div>
                
                {/* EXTRA MISSIONS BUTTON - DISE√ëO DE LUJO Y COMPACTO */}
                <button 
                  onClick={() => setShowExtras(true)}
                  className="absolute bottom-[max(env(safe-area-inset-bottom,24px),24px)] left-1/2 -translate-x-1/2 z-40 bg-black/60 backdrop-blur-xl text-white px-6 py-3.5 rounded-full font-black text-[11px] tracking-[0.2em] shadow-[0_10px_30px_rgba(0,0,0,0.8)] border border-cyan-500/40 flex items-center justify-center gap-3 active:scale-95 transition-all hover:bg-black/80 hover:border-cyan-400 hover:shadow-[0_0_25px_rgba(6,182,212,0.3)] whitespace-nowrap"
                >
                  <i className="fa-solid fa-bolt text-cyan-400 drop-shadow-[0_0_8px_rgba(34,211,238,0.8)] text-sm"></i>
                  EXTRA MISSIONS
                </button>
              </div>

              {/* --- MODAL: PREGUNTA (GLASSMORPHISM) --- */}
              {activeQuestionBar && (
                <div className="fixed inset-0 z-[60] bg-slate-950/80 backdrop-blur-md p-4 flex items-center justify-center">
                  <div className="glass-panel w-full max-w-sm rounded-[2rem] flex flex-col shadow-[0_0_50px_rgba(0,0,0,0.8)] border border-white/10 relative animate-in zoom-in-95 duration-300">
                    <button onClick={() => setActiveQuestionBar(null)} className="absolute top-4 right-4 w-10 h-10 bg-white/5 hover:bg-white/10 rounded-full flex items-center justify-center text-slate-300"><i className="fa-solid fa-xmark text-lg"></i></button>

                    <div className="p-8">
                      <div className="flex justify-center mb-6">
                        <div className="w-20 h-20 rounded-full bg-slate-900 border-2 border-cyan-500 shadow-[0_0_30px_rgba(6,182,212,0.4)] flex items-center justify-center">
                          <i className="fa-solid fa-unlock-keyhole text-cyan-400 text-3xl"></i>
                        </div>
                      </div>

                      <h3 className="text-center text-2xl font-black text-white mb-2 tracking-tight">Access Code</h3>
                      <p className="text-center text-slate-400 text-sm mb-8 font-medium">Solve the riddle to reveal the bar.</p>

                      <div className="bg-slate-900/80 p-5 rounded-2xl border border-white/5 mb-6 shadow-inner">
                         <p className="text-center font-bold text-slate-200 text-[15px] leading-relaxed">{activeQuestionBar.trivia.q}</p>
                      </div>

                      <form onSubmit={submitAnswer} className="space-y-4">
                        <div>
                          <input 
                            type="text" 
                            value={answerInput}
                            onChange={(e) => { setAnswerInput(e.target.value); setAnswerError(false); }}
                            placeholder="Your answer..."
                            className={`w-full bg-slate-950/50 border-2 text-center text-xl font-bold p-4 rounded-2xl outline-none transition-all shadow-inner
                              ${answerError ? 'border-rose-500/80 text-rose-400 focus:bg-rose-950/20' : 'border-white/10 text-white focus:border-cyan-500 focus:bg-cyan-950/10'}
                            `}
                            autoFocus
                          />
                          {answerError && <p className="text-rose-400 text-xs text-center mt-3 font-bold uppercase tracking-wider animate-bounce">Incorrect! Try again.</p>}
                        </div>
                        
                        <button 
                          type="submit"
                          className="w-full py-4 mt-2 bg-slate-950 border border-cyan-500/50 text-cyan-400 font-black text-sm rounded-2xl shadow-[0_0_20px_rgba(6,182,212,0.15)] hover:shadow-[0_0_30px_rgba(6,182,212,0.3)] hover:bg-slate-900 active:scale-95 transition-all flex items-center justify-center gap-3 tracking-[0.2em] uppercase"
                        >
                          DECRYPT <i className="fa-solid fa-fingerprint text-lg"></i>
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              )}

              {/* --- MODAL: EXTRA MISSIONS --- */}
              {showExtras && (
                <div className="fixed inset-0 z-50 bg-slate-950/80 backdrop-blur-md flex items-end sm:items-center justify-center p-0 sm:p-4">
                  <div className="glass-panel w-full sm:max-w-md h-[85vh] sm:h-[80vh] rounded-t-[2.5rem] sm:rounded-[2.5rem] flex flex-col shadow-2xl border-t sm:border border-white/10 animate-in slide-in-from-bottom sm:zoom-in duration-300">
                    <div className="p-6 border-b border-white/5 flex justify-between items-center relative">
                      <div className="absolute top-3 left-1/2 -translate-x-1/2 w-12 h-1.5 bg-white/20 rounded-full sm:hidden"></div>
                      <h2 className="text-2xl font-black text-white tracking-tight mt-2 sm:mt-0">Extra Missions</h2>
                      <button onClick={() => setShowExtras(false)} className="w-10 h-10 bg-white/5 hover:bg-white/10 rounded-full flex items-center justify-center text-slate-300 mt-2 sm:mt-0"><i className="fa-solid fa-xmark"></i></button>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-[max(env(safe-area-inset-bottom),24px)]">
                      {EXTRA_CHALLENGES.map((ch) => {
                        const isDone = userState.extraCompleted.includes(ch.id);
                        return (
                          <div 
                            key={ch.id} 
                            onClick={() => toggleExtraChallenge(ch.id)}
                            className={`p-5 rounded-3xl border transition-all cursor-pointer relative shadow-sm active:scale-[0.98]
                              ${isDone ? 'bg-emerald-900/20 border-emerald-500/40' : 'bg-slate-900/60 border-white/5 hover:border-cyan-500/50'}
                            `}
                          >
                            <div className="flex items-start gap-4">
                              <div className={`mt-0.5 w-7 h-7 rounded-xl border-2 flex items-center justify-center shrink-0 shadow-inner transition-colors ${isDone ? 'bg-emerald-500 border-emerald-400' : 'border-slate-600 bg-slate-800'}`}>
                                  {isDone && <i className="fa-solid fa-check text-white text-sm font-black"></i>}
                              </div>
                              <div>
                                <div className="flex items-center gap-2 mb-1.5">
                                  {getLevelBadge(ch.level)}
                                  <span className={`text-xs font-black ${isDone ? 'text-emerald-400' : 'text-slate-400'}`}>{ch.points * 100} PTS</span>
                                </div>
                                <h4 className={`font-black text-[15px] leading-tight ${isDone ? 'text-slate-500 line-through' : 'text-slate-100'}`}>{ch.text}</h4>
                                <p className={`text-[13px] mt-1.5 leading-relaxed ${isDone ? 'text-slate-600' : 'text-slate-400'}`}>{ch.description}</p>
                              </div>
                            </div>
                          </div>
                        )
                      })}
                    </div>
                  </div>
                </div>
              )}

              {/* --- DRAWER: DETALLES DEL BAR (Safe Area Bottom) --- */}
              {activeBar && (
                <div className="fixed inset-x-0 bottom-0 z-50 h-auto">
                  <div className="fixed inset-0 bg-slate-950/60 backdrop-blur-sm" onClick={() => setActiveBar(null)}></div>
                  
                  <div className="glass-panel border-t border-white/10 rounded-t-[2.5rem] p-6 pb-[max(env(safe-area-inset-bottom,32px),32px)] shadow-[0_-20px_50px_rgba(0,0,0,0.8)] relative animate-in slide-in-from-bottom duration-300 max-h-[85vh] overflow-y-auto">
                    {/* Handle for mobile drawer */}
                    <div className="absolute top-3 left-1/2 -translate-x-1/2 w-12 h-1.5 bg-white/20 rounded-full"></div>
                    
                    <button onClick={() => setActiveBar(null)} className="absolute top-6 right-6 w-10 h-10 bg-white/5 hover:bg-white/10 rounded-full flex items-center justify-center text-slate-300"><i className="fa-solid fa-xmark text-lg"></i></button>

                    <div className="space-y-6 max-w-lg mx-auto pt-6">
                      <div>
                        <h2 className="text-4xl font-black text-white leading-none tracking-tighter drop-shadow-md">{activeBar.name}</h2>
                        <div className="flex items-center gap-3 mt-3">
                            <span className="px-3 py-1 rounded-md bg-white/10 text-xs font-bold text-slate-300 border border-white/5 uppercase tracking-widest shadow-inner">District VII</span>
                            {getLevelBadge(activeBar.challenge.level)}
                        </div>
                      </div>

                      <div 
                        onClick={() => toggleChallenge(activeBar.id)}
                        className={`cursor-pointer p-6 rounded-[2rem] border-2 transition-all active:scale-[0.98] shadow-lg relative overflow-hidden group
                          ${isCompleted(activeBar.id) 
                            ? 'bg-emerald-900/30 border-emerald-500/50' 
                            : getLevelColor(activeBar.challenge.level).replace('text-', 'border-')
                          }`}
                      >
                        <div className="flex items-start gap-4 relative z-10">
                          <div className={`w-14 h-14 rounded-full flex items-center justify-center flex-shrink-0 shadow-inner transition-colors
                              ${isCompleted(activeBar.id) ? 'bg-emerald-500 border-2 border-emerald-400' : 'border-2 border-white/10 bg-slate-900/80'}
                            `}
                          >
                            {isCompleted(activeBar.id) ? <i className="fa-solid fa-check text-white text-2xl font-black"></i> : <i className="fa-solid fa-bolt text-slate-300 text-2xl"></i>}
                          </div>
                          <div>
                            <h3 className="text-xl font-black tracking-tight flex items-center gap-2 text-white">
                              CHALLENGE
                              <span className="text-xs font-black bg-slate-950/50 px-2 py-0.5 rounded-md border border-white/5 text-slate-300">{activeBar.challenge.points * 100} PTS</span>
                            </h3>
                            <p className="font-bold text-[15px] mt-1.5 leading-snug text-slate-200">{activeBar.challenge.text}</p>
                            <p className="mt-1.5 text-sm leading-relaxed text-slate-400">{activeBar.challenge.description}</p>
                            
                            <div className={`mt-4 text-[11px] font-black uppercase tracking-widest py-2 px-4 rounded-xl inline-block transition-colors shadow-inner
                              ${isCompleted(activeBar.id) ? 'bg-emerald-500 text-white' : 'bg-slate-950/50 text-slate-300 group-hover:bg-slate-900'}
                            `}>
                              {isCompleted(activeBar.id) ? 'MISSION COMPLETE' : 'TAP TO MARK AS DONE'}
                            </div>
                          </div>
                        </div>
                      </div>

                      <a 
                        href={activeBar.link} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="flex items-center justify-center gap-3 w-full py-4 h-14 bg-slate-950 border border-white/10 text-white hover:border-cyan-500/50 rounded-2xl font-black uppercase tracking-[0.15em] transition-all shadow-xl active:scale-95 text-xs"
                      >
                        <i className="fa-solid fa-location-arrow text-cyan-400 text-sm"></i> 
                        <span>Open in Maps</span>
                      </a>
                    </div>
                  </div>
                </div>
              )}

              {showConfetti && (
                <div className="fixed inset-0 pointer-events-none z-[100] flex justify-center items-center backdrop-blur-sm bg-slate-950/20">
                   <div className="text-[120px] animate-bounce drop-shadow-[0_0_50px_rgba(255,255,255,0.8)] filter">üçª</div>
                </div>
              )}

            </div>
          );
        };

        const rootElement = document.getElementById('root');
        if(window.React && window.ReactDOM) {
            const root = ReactDOM.createRoot(rootElement);
            root.render(<App />);
        } else {
            rootElement.innerHTML = "<h2 style='color:red; text-align:center; margin-top:50px;'>Error: Libraries didn't load.</h2>";
        }
    </script>
</body>
</html>
